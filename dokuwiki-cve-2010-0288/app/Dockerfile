# Use Ubuntu 12.04 as the base image
FROM ubuntu:12.04

# Set environment variables for non-interactive installation
ENV DEBIAN_FRONTEND noninteractive

# Update sources.list to use old-releases
RUN sed -i 's/archive.ubuntu.com/old-releases.ubuntu.com/g' /etc/apt/sources.list

# Set the working directory
WORKDIR /var/www/html

# Install required packages and dependencies for building PHP 5.2
RUN apt-get update && \
    apt-get install -y wget build-essential libxml2-dev libssl-dev libcurl4-openssl-dev \
    apache2 apache2-dev libpng12-dev libjpeg62-dev libfreetype6-dev libmysqlclient-dev \
    curl

COPY php-5.2.17.tar.gz /tmp/php-5.2.17.tar.gz
RUN cd /tmp && \
    tar -xzvf php-5.2.17.tar.gz && \
    cd php-5.2.17 && \
    ./configure --with-apxs2=/usr/bin/apxs2 --with-mysql --with-libdir=/lib/x86_64-linux-gnu \
                --with-jpeg-dir=/usr --with-png-dir=/usr --with-freetype-dir=/usr && \
    make && \
    make install && \
    cp php.ini-recommended /usr/local/lib/php.ini && \
    echo "LoadModule php5_module /usr/lib/apache2/modules/libphp5.so" >> /etc/apache2/apache2.conf && \
    echo "AddType application/x-httpd-php .php" >> /etc/apache2/apache2.conf && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/* /tmp/*

# Create the directory for DokuWiki
RUN mkdir -p /var/www/dokuwiki

# Copy the pre-downloaded DokuWiki tarball to the Docker container
COPY dokuwiki-2009-12-25.tgz /tmp/dokuwiki-2009-12-25.tgz

# Extract DokuWiki
RUN tar -xzvf /tmp/dokuwiki-2009-12-25.tgz --strip-components=1 -C /var/www/dokuwiki && \
    chown -R www-data:www-data /var/www/dokuwiki && \
    rm /tmp/dokuwiki-2009-12-25.tgz

# Copy custom dokuwiki configs
COPY acl.auth.php /var/www/dokuwiki/conf/acl.auth.php
COPY local.php /var/www/dokuwiki/conf/local.php
COPY users.auth.php /var/www/dokuwiki/conf/users.auth.php
COPY start.txt /var/www/dokuwiki/data/pages/start.txt

# This is passed as a build-arg and should be used to inject the chosen flag into the image
ARG flag
RUN echo -n $flag > /var/www/dokuwiki/data/pages/wiki/private.txt



RUN chmod -R 777 /var/www/dokuwiki

# Update the Apache configuration to point to DokuWiki
RUN echo "<VirtualHost *:80>\n\
    DocumentRoot /var/www/dokuwiki\n\
    <Directory /var/www/dokuwiki>\n\
        Options FollowSymLinks\n\
        AllowOverride All\n\
        Order allow,deny\n\
        Allow from all\n\
    </Directory>\n\
    ErrorLog \${APACHE_LOG_DIR}/error.log\n\
    CustomLog \${APACHE_LOG_DIR}/access.log combined\n\
</VirtualHost>" > /etc/apache2/sites-available/default

# Enable Apache rewrite module
RUN a2enmod rewrite

# Expose port 80
EXPOSE 80

# Start Apache in the foreground
CMD ["apache2ctl", "-D", "FOREGROUND"]

